<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cars NL Query</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .controls{display:flex; gap:10px; align-items:center; margin-top:10px}
    textarea{width:100%; min-height:110px; padding:10px; font-size:15px; border:1px solid #d7e1eb; border-radius:8px; resize:vertical; font-family:inherit}
    button{background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:8px; font-weight:600; cursor:pointer}
    button:hover{filter:brightness(0.96)}
    button:disabled{opacity:0.6; cursor:not-allowed}
    .status{margin:10px 0 0; color:#333}
    .error{color:#b00020}
    .muted{color:var(--muted)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
    .how-btn{background:white; color:var(--accent); border:1px solid #d7e1eb; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(15,23,42,0.08)}
    .how-btn:hover{filter:brightness(0.98)}
    .modal-overlay{position:fixed; inset:0; background:rgba(19,33,68,0.4); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000; opacity:0; transition:opacity 0.2s ease}
    .modal-overlay.show{display:flex; opacity:1}
    .modal-card{background:white; max-width:720px; width:100%; border-radius:14px; box-shadow:0 18px 38px rgba(15,23,42,0.18); padding:22px; position:relative; max-height:90vh; overflow:auto}
    .modal-card h3{margin:0 0 10px; color:var(--accent)}
    .modal-card p{margin:0 0 12px; line-height:1.6}
    .modal-card .bullets{margin:8px 0 16px; padding-left:18px}
    .modal-card .bullets li{margin:6px 0; line-height:1.5}
    .modal-close{position:absolute; top:10px; right:10px; border:none; background:transparent; font-size:18px; cursor:pointer; color:#555}
    .modal-close:hover{color:#111}
    @media (max-width:520px){
      .modal-card{padding:16px}
      .how-btn{width:100%}
    }
    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:12px; margin-top:16px}
    .card{background:#f7f9fb; border:1px solid #e6eef6; border-radius:10px; padding:12px; display:none}
    .card h3{margin:0 0 8px; font-size:15px; color:#0b66c2}
    .card-top{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .pill{background:var(--accent); color:white; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .rows-content{background:white; border:1px solid #d7e1eb; border-radius:8px; padding:10px; min-height:80px}
    .rows-content.muted{color:var(--muted)}
    .table-wrap{overflow:auto}
    .data-table{width:100%; border-collapse:collapse; font-size:14px}
    .data-table th, .data-table td{padding:8px 10px; border:1px solid #e6eef6; text-align:left}
    .data-table th{background:#f1f6fb; position:sticky; top:0; z-index:1}
    pre{margin:0; background:white; border:1px solid #d7e1eb; border-radius:8px; padding:10px; white-space:pre-wrap; word-break:break-word; font-size:14px}
  </style>
</head>
<body>
  <main class="container">
    <header class="header">
      <div>
        <h1 class="name">Cars NL Query</h1>
        <p class="title">Ask natural-language questions; see SQL + results.</p>
      </div>
      <button id="how-btn" class="how-btn" type="button">What is this?</button>
    </header>

    <section class="section">
      <h2>Ask the database</h2>
      <p>Type a question about the <code>cars</code> table (brand, model, year, mileage_km, price_eur, accident_history, fuel_type, transmission).</p>
      <form id="ask-form">
        <label for="question" class="sr-only">Question</label>
        <textarea id="question" name="question" placeholder="Example: Show the top 5 cheapest diesel cars with automatic transmission."></textarea>
        <div class="controls">
          <button type="submit" id="ask-btn">Ask DB</button>
          <div id="status" class="status" aria-live="polite">Waiting for your question.</div>
        </div>
      </form>

      <div class="cards">
        <div class="card" id="sql-card">
          <h3>Generated SQL</h3>
          <pre id="sql-output">(waiting)</pre>
        </div>
        <div class="card" id="rows-card">
          <div class="card-top">
            <h3>Results</h3>
            <span id="row-count" class="pill">0 rows</span>
          </div>
          <div id="rows-output" class="rows-content muted">Awaiting query.</div>
        </div>
      </div>
    </section>
  </main>

  <div id="modal-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button class="modal-close" type="button" aria-label="Close modal">&times;</button>
      <h3 id="modal-title">What is this?</h3>
      <p>This is an AI-powered Car Search Assistant.<br>
      Instead of writing SQL or filtering manually, you can simply type what you want in natural language:</p>
      <p>Example prompts you can try:</p>
      <ul class="bullets">
        <li>“Show all BMW cars newer than 2018 under 80,000 km.”</li>
        <li>“List the top 5 cheapest diesel cars.”</li>
        <li>“Show automatic SUVs sorted by mileage ascending.”</li>
        <li>“Show cars with no accident history and price under 10,000.”</li>
      </ul>
      <p>The assistant understands your intent, turns it into SQL, validates it for safety, and returns clean, structured data from the cars database.</p>
      <h3>How This Works (Technical Overview)</h3>
      <p>This demo shows a complete AI → SQL → DB pipeline running fully serverless:</p>
      <ul class="bullets">
        <li>A Groq LLM interprets plain-English questions.</li>
        <li>The LLM generates SQL that is automatically cleaned and validated.</li>
        <li>A custom safety layer ensures the SQL is read-only (SELECT/WITH only).</li>
        <li>A serverless SQLite engine executes the query on the cars database.</li>
        <li>Results are rendered as a dynamic, responsive HTML table.</li>
      </ul>
      <p>The app demonstrates modern agentic AI patterns:<br>
      natural-language reasoning, safe tool-calling, database interaction, and serverless execution — all deployed on Vercel.</p>
    </div>
  </div>

  <script>
    (function(){
      const form = document.getElementById('ask-form');
      const questionField = document.getElementById('question');
      const statusEl = document.getElementById('status');
      const sqlCard = document.getElementById('sql-card');
      const rowsCard = document.getElementById('rows-card');
      const sqlOutput = document.getElementById('sql-output');
      const rowsOutput = document.getElementById('rows-output');
      const rowCount = document.getElementById('row-count');
      const askBtn = document.getElementById('ask-btn');
      const howBtn = document.getElementById('how-btn');
      const modalOverlay = document.getElementById('modal-overlay');
      const modalClose = modalOverlay.querySelector('.modal-close');

      function setStatus(text, isError){
        statusEl.textContent = text;
        statusEl.className = isError ? 'status error' : 'status';
      }

      function renderRows(rows){
        let count = 0;
        rowsOutput.innerHTML = '';
        rowsOutput.className = 'rows-content';

        if (Array.isArray(rows)) {
          count = rows.length;
          rowCount.textContent = count === 1 ? '1 row' : `${count} rows`;
          if (!rows.length) {
            rowsOutput.textContent = 'No rows returned.';
            rowsOutput.classList.add('muted');
            return;
          }
          const keys = Object.keys(rows[0] || {});
          if (!keys.length) {
            rowsOutput.textContent = 'Rows returned but no columns to show.';
            rowsOutput.classList.add('muted');
            return;
          }
          const table = document.createElement('table');
          table.className = 'data-table';
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          keys.forEach(k => {
            const th = document.createElement('th');
            th.textContent = k;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          rows.forEach(row => {
            const tr = document.createElement('tr');
            keys.forEach(k => {
              const td = document.createElement('td');
              const val = row && Object.prototype.hasOwnProperty.call(row, k) ? row[k] : '';
              td.textContent = val === null || typeof val === 'undefined' ? '' : val;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          const wrap = document.createElement('div');
          wrap.className = 'table-wrap';
          wrap.appendChild(table);
          rowsOutput.appendChild(wrap);
          return;
        }

        if (rows && typeof rows === 'object') {
          const keys = Object.keys(rows);
          if (!keys.length) {
            rowCount.textContent = '0 rows';
            rowsOutput.textContent = 'No data returned.';
            rowsOutput.classList.add('muted');
            return;
          }
          count = 1;
          rowCount.textContent = '1 row';
          const table = document.createElement('table');
          table.className = 'data-table';
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          keys.forEach(k => {
            const th = document.createElement('th');
            th.textContent = k;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          const tr = document.createElement('tr');
          keys.forEach(k => {
            const td = document.createElement('td');
            const val = Object.prototype.hasOwnProperty.call(rows, k) ? rows[k] : '';
            td.textContent = val === null || typeof val === 'undefined' ? '' : val;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
          table.appendChild(tbody);
          const wrap = document.createElement('div');
          wrap.className = 'table-wrap';
          wrap.appendChild(table);
          rowsOutput.appendChild(wrap);
          return;
        }

        rowCount.textContent = '0 rows';
        rowsOutput.textContent = rows === null || typeof rows === 'undefined' ? 'No data returned.' : String(rows);
        rowsOutput.classList.add('muted');
      }

      function openModal(){
        modalOverlay.classList.add('show');
        modalOverlay.setAttribute('aria-hidden', 'false');
      }

      function closeModal(){
        modalOverlay.classList.remove('show');
        modalOverlay.setAttribute('aria-hidden', 'true');
      }

      howBtn.addEventListener('click', openModal);
      modalClose.addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) closeModal();
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const question = questionField.value.trim();
        if (!question) {
          setStatus('Please enter a question.', true);
          return;
        }

        askBtn.disabled = true;
        setStatus('Sending to /api/nl-query...');
        sqlCard.style.display = 'none';
        rowsCard.style.display = 'none';
        sqlOutput.textContent = '';
        rowCount.textContent = '—';
        rowsOutput.innerHTML = '';
        rowsOutput.className = 'rows-content muted';
        rowsOutput.textContent = 'Waiting...';

        try {
          const response = await fetch('/api/nl-query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
          });

          const text = await response.text();
          let data;
          try {
            data = text ? JSON.parse(text) : {};
          } catch (err) {
            data = null;
          }

          if (!response.ok) {
            const message = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${response.status}`;
            setStatus('Error: ' + message, true);
            if (data && data.sql) {
              sqlOutput.textContent = data.sql;
              sqlCard.style.display = 'block';
            }
            return;
          }

          const sql = data && data.sql ? data.sql : '';
          const rows = data && typeof data.rows !== 'undefined' ? data.rows : data;

          sqlOutput.textContent = sql || '(no SQL returned)';
          renderRows(rows);
          sqlCard.style.display = 'block';
          rowsCard.style.display = 'block';
          setStatus('Query succeeded.');
        } catch (err) {
          setStatus('Error: ' + (err && err.message ? err.message : String(err)), true);
        } finally {
          askBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
